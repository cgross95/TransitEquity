---
title: "Job Accessibility Regression Analysis"
author: "Transit Equity Team"
date: '2022-06-13'
output:
  pdf_document: default
  html_document: default
---

# Loading data

```{r libraries, message=FALSE}
library(tidyverse)
library(modelr)
library(gt)
source("./compile_ja_svi_transit_time.r")
```

```{r load-data}
df <- load_all_data("../processed_data/", "../raw_data/")
```

# Plot job accessibility and transit time results

## Segments separated by plots
```{r job-accessibility-plots}
vs_svi <- function(df,
                   var,
                   ...,
                   seg_choice = unique(df$segment),
                   threshold_choice = unique(df$threshold),
                   speed_choice = unique(df$speed),
                   mode_choice = c("transit", "red_line")) {
  # var is either gravity_sum or average_commute_time
  # all additional arguments are filters for df
  filtered_df <- df %>%
    filter(
      segment %in% seg_choice,
      threshold %in% threshold_choice,
      speed %in% speed_choice,
      mode %in% mode_choice,
      ...)
  ggplot(data = filtered_df, mapping = aes(svi_socioecon_summary, {{ var }})) +
    geom_point(alpha = 0.4) +
    geom_smooth(method = "lm", formula = "y ~ x") +
    facet_grid(segment + speed + mode ~ threshold)
}

pwalk(df %>% select(segment) %>% unique(),
      ~show(vs_svi(df,
                   gravity_sum,
                   seg_choice = ..1)))

pwalk(df %>% select(segment) %>% unique(),
      ~show(vs_svi(df,
                   gravity_sum,
                   seg_choice = ..1,
                   mode_choice = "pct_difference")))

pwalk(df %>% select(segment) %>% unique(),
      ~show(vs_svi(df,
                   average_commute_time,
                   seg_choice = ..1)))

pwalk(df %>% select(segment) %>% unique(),
      ~show(vs_svi(df,
                   average_commute_time,
                   seg_choice = ..1,
                   mode_choice = "pct_difference")))
```

## An example of extracting outlier tracts

```{r}
save_outlier_tracts <- function(var, segment_choice, speed_choice,
                                threshold_choice,
                                mode_choice = "pct_difference") {
  filtered_df <- df %>%
  filter(
    segment == segment_choice,
    threshold == threshold_choice,
    speed == speed_choice,
    mode == mode_choice)
  dir <- str_glue("../processed_data/outliers/{segment_choice}/{speed_choice}/{threshold_choice}/{mode_choice}")
  dir.create(dir, showWarnings = FALSE, recursive = TRUE)
  filename <- str_glue("{dir}/{var}.csv")
  if (var == "average_commute_time") {
    filtered_df <- filtered_df %>% 
      filter(average_commute_time <  boxplot.stats(average_commute_time)$stats[1])
  } else if (var == "gravity_sum") {
    filtered_df <- filtered_df %>% 
    filter(gravity_sum >  boxplot.stats(gravity_sum)$stats[5])
  }
  filtered_df %>%
    select(FIPS, .data[[var]]) %>%
    unique() %>% 
    write_csv(filename)
  print(filename)
}
# save_outlier_tracts("gravity_sum", "SE01", 20, 30)

filtered_df <- df %>%
  filter(
    segment == "SE01",
    threshold == 15,
    speed == 20,
    mode == "difference")

ggplot(data = filtered_df, mapping = aes(svi_socioecon_summary, gravity_sum)) +
  geom_point(alpha = 0.4) +
  geom_smooth(method = "lm", formula = "y ~ x") +
  geom_boxplot(mapping = aes(x = 3))

filtered_df %>%
  filter(gravity_sum > boxplot.stats(gravity_sum, coef=3)$stats[5]) %>%
  select(FIPS, gravity_sum) %>%
  unique()

filtered_df %>%
  filter(average_commute_time < boxplot.stats(average_commute_time, coef=3)$stats[1]) %>%
  select(FIPS, average_commute_time) %>%
  unique()
```